# Portal de Luz - Sistema de Gestión de Consumo y Pagos (UPIS Las Palmeras del Sol)

## Contexto del Proyecto
Aplicación web para gestionar el consumo de energía eléctrica y agua, facturación, y estado de pagos para los lotes de la comunidad "UPIS Las Palmeras del Sol". El sistema permite a los administradores gestionar lotes, tarifas mensuales y recibos, y ofrece una vista pública para que los vecinos consulten sus deudas mediante DNI.

## Stack Tecnológico
- **Frontend**: Next.js 14+ (App Router), React, TypeScript.
- **Backend/Database**: Supabase (PostgreSQL, Auth, RLS).
- **UI**: Tailwind CSS, Shadcn UI, Lucide React.
- **Despliegue**: Vercel (implícito por Next.js).

## Requerimientos Funcionales Principales

### 1. Gestión de Lotes (Vecinos)
- **Entidades**: Manzana, Número de Lote, Nombres, Apellidos, DNI, Celular.
- **Estado del Lote**:
  - `HABITADO`: Lote con consumo activo.
  - `SOLO_MANTENIMIENTO`: Lote sin consumo pero paga mantenimiento/alumbrado.
  - `BALDIO`: Lote vacío sin cobro (o según reglas específicas).
- **Restricciones**: Unicidad en la combinación Manzana + Lote.

### 2. Gestión de Tarifas Mensuales
- Definición de costos por periodo (Mes/Año).
- **Variables**:
  - Precio por kWh (ej. 0.86 soles).
  - Costo fijo por Alumbrado Público (ej. 10.00 soles).
- **Estados**: `ABIERTO` (permite modificaciones/creación de recibos), `CERRADO` (histórico).

### 3. Registro de Consumo y Generación de Recibos
- Registro de lectura de consumo (kWh) por lote en un periodo tarifa activo.
- **Cálculo Automático**:
  - `Total Consumo = (Consumo kWh * Precio kWh) + Alumbrado Público`.
  - `Total a Pagar = REDONDEAR(Total Consumo)`. (Redondeo estándar).
- **Estado Inicial**: `PENDIENTE`.

### 4. Gestión de Pagos
- Marcar recibos como `PAGADO` o `PENDIENTE`.
- Registro de fecha de pago.
- Visualización de estado (VENCIDO si pasa la fecha límite, aunque la lógica actual es simple pendiente/pagado).

### 5. Consulta Pública
- Interfaz accesible sin login para buscar deudas por DNI.
- Muestra lista de recibos pendientes y pagados asociados al DNI.

## SQL Schema
-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.lotes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  manzana character NOT NULL,
  lote_numero integer NOT NULL,
  nombres character varying,
  apellidos character varying,
  dni character varying,
  tipo_servicio USER-DEFINED DEFAULT 'HABITADO'::estado_lote,
  created_at timestamp with time zone DEFAULT now(),
  celular text,
  CONSTRAINT lotes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recibos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lote_id bigint,
  tarifa_id bigint,
  consumo_kwh numeric NOT NULL DEFAULT 0,
  precio_x_kwh numeric NOT NULL,
  alumbrado_publico numeric NOT NULL,
  total_consumo numeric DEFAULT ((consumo_kwh * precio_x_kwh) + alumbrado_publico),
  estado USER-DEFINED DEFAULT 'PENDIENTE'::estado_pago,
  fecha_pago timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  total_recibo integer DEFAULT round(((consumo_kwh * precio_x_kwh) + alumbrado_publico)),
  CONSTRAINT recibos_pkey PRIMARY KEY (id),
  CONSTRAINT recibos_tarifa_id_fkey FOREIGN KEY (tarifa_id) REFERENCES public.tarifas_mensuales(id),
  CONSTRAINT recibos_lote_id_fkey FOREIGN KEY (lote_id) REFERENCES public.lotes(id)
);
CREATE TABLE public.tarifas_mensuales (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  periodo date NOT NULL UNIQUE,
  precio_kwh numeric NOT NULL DEFAULT 0.86,
  costo_alumbrado numeric NOT NULL DEFAULT 10.00,
  estado USER-DEFINED DEFAULT 'ABIERTO'::estado_periodo,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tarifas_mensuales_pkey PRIMARY KEY (id)
);
